var R=Object.defineProperty;var k=n=>{throw TypeError(n)};var $=(n,t,e)=>t in n?R(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var a=(n,t,e)=>$(n,typeof t!="symbol"?t+"":t,e),E=(n,t,e)=>t.has(n)||k("Cannot "+e);var d=(n,t,e)=>(E(n,t,"read from private field"),e?e.call(n):t.get(n)),b=(n,t,e)=>t.has(n)?k("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),_=(n,t,e,s)=>(E(n,t,"write to private field"),s?s.call(n,e):t.set(n,e),e);import{O as f,T as p,V as L,M as T,G as q,d as y,c as P,o as K,a as w,b as v,_ as D,e as W,f as l,t as A,g as z,h as Y,u as X,p as j,i as H,j as x}from"./index-DRZW0PWk.js";var g=(n=>(n.F32="f32",n.U32="u32",n.VEC4F="vec4f",n.VEC4U="vec4u",n))(g||{});function M(n){switch(n){case"f32":case"u32":return 1;case"vec4f":case"vec4u":return 4}}var c;class Z{constructor(t,e){a(this,"type");b(this,c);a(this,"is_dirty");a(this,"size_components");a(this,"size_bytes");if(this.type=t,this.size_components=M(t),this.size_bytes=this.size_components*4,e.length!==this.size_components)throw new Error(`Uniform: expected ${this.size_components}, got ${e.length}`);_(this,c,new Uint32Array(e.buffer)),this.is_dirty=!0}get value(){return d(this,c)}set value(t){const e=new Uint32Array(t.buffer);if(e.length!==this.size_components)throw new Error(`value must be an array of length ${this.size_components}`);let s=!1;for(let i=0;i<e.length;i++)if(e[i]!==d(this,c)[i]){s=!0;break}s&&(this.is_dirty=!0,_(this,c,e))}}c=new WeakMap;var u;class U{constructor(t,e,s){a(this,"type");a(this,"size_components");a(this,"size_bytes");b(this,u);a(this,"is_dirty");this.type=t;const i=M(t);if(this.size_components=e*i,this.size_bytes=this.size_components*4,i%4!==0)throw new Error("Array values must be a multiple of 4 components");if(s.length!==this.size_components)throw new Error(`Array must have length ${this.size_components} got ${s.length}`);_(this,u,new Uint32Array(s.buffer)),this.is_dirty=!0}get value(){return d(this,u)}set value(t){const e=new Uint32Array(t.buffer);if(e.length!==this.size_components)throw new Error(`value must be an array of length ${this.size_components}`);let s=!1;for(let i=0;i<e.length;i++)if(e[i]!==d(this,u)[i]){s=!0;break}s&&(this.is_dirty=!0,_(this,u,e))}}u=new WeakMap;class O{constructor(t,e){a(this,"binding");a(this,"member_names");a(this,"member_map");a(this,"buffer");a(this,"size_components");a(this,"size_bytes");a(this,"values");this.binding=t,this.member_names=e.map(s=>s.name),this.member_map={};for(const s of e)this.member_map[s.name]=s.value;this.size_components=e.map(s=>s.value.size_components).reduce((s,i)=>s+i,0),this.size_bytes=this.size_components*4,this.values=new Uint32Array(this.size_components)}create(t){if(this.buffer)throw new Error("uniform buffer already exists!");this.buffer=t.createBuffer({size:this.size_bytes,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:!1}),this.update_buffer(t)}update_buffer(t){if(!this.buffer)throw new Error("Buffer hasn't been created yet!");if(!Object.values(this.member_map).some(i=>i.is_dirty))return;let s=0;for(let i=0;i<this.member_names.length;i++){const o=this.member_names[i],r=this.member_map[o];r.is_dirty&&(this.values.set(r.value,s),r.is_dirty=!1),s+=r.size_components}t.queue.writeBuffer(this.buffer,0,this.values)}get layout_entry(){return{binding:this.binding,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}}get bind_group_entry(){if(!this.buffer)throw new Error("buffer not ready yet!");return{binding:this.binding,resource:{buffer:this.buffer}}}get_uniform(t){return this.member_map[t]}update(t){this.update_buffer(t)}}class J{constructor(){a(this,"keysPressed");this.keysPressed=new Map}init(){window.addEventListener("keydown",t=>{this.keysPressed.set(t.code,!0),t.preventDefault()}),window.addEventListener("keyup",t=>{this.keysPressed.set(t.code,!1),t.preventDefault()})}digital_key(t){return new f(()=>this.keysPressed.get(t)??!1)}get arrow_axes(){return[new p(this.digital_key("ArrowLeft"),this.digital_key("ArrowRight")),new p(this.digital_key("ArrowDown"),this.digital_key("ArrowUp"))]}get wasd_axes(){return[new p(this.digital_key("KeyA"),this.digital_key("KeyD")),new p(this.digital_key("KeyS"),this.digital_key("KeyW"))]}}function Q(n){const t=s=>{s.target===n&&s.preventDefault()},e={passive:!1};document.body.addEventListener("touchstart",t,e),document.body.addEventListener("touchend",t,e),document.body.addEventListener("touchmove",t,e)}function m(n,t,e){const s=n.getBoundingClientRect(),i=t-s.left,o=e-s.top;return new L(i,o)}function S(n,t,e){return Math.min(Math.max(n,t),e)}function B(n,t,e,s){return n>=0&&n<e&&t>=0&&t<s}const C=.1;class tt{constructor(t){a(this,"pressed");a(this,"position");a(this,"canvas");this.pressed=!1,this.position=new L(0,0),this.canvas=t}init(){Q(this.canvas),this.canvas.addEventListener("pointerdown",t=>{this.pressed=!0,this.position=m(this.canvas,t.clientX,t.clientY)}),this.canvas.addEventListener("pointermove",t=>{this.position=m(this.canvas,t.clientX,t.clientY)}),this.canvas.addEventListener("pointerleave",t=>{this.position=m(this.canvas,t.clientX,t.clientY)}),this.canvas.addEventListener("pointerup",t=>{this.pressed=!1,this.position=m(this.canvas,t.clientX,t.clientY)})}get pressed_signal(){return new f(()=>this.pressed)}get screen_axes(){const t=new f(()=>{const{width:s,height:i}=this.canvas.getBoundingClientRect(),o=s/2,r=s/2;if(!B(this.position.x,this.position.y,s,i))return 0;const h=(this.position.x-o)/r;return Math.abs(h)<C?0:S(h,-1,1)}),e=new f(()=>{const{width:s,height:i}=this.canvas.getBoundingClientRect(),o=i/2;if(!B(this.position.x,this.position.y,s,i))return 0;const r=s/2,h=(this.position.y-o)/r;return Math.abs(h)<C?0:-S(h,-1,1)});return[t,e]}}const N=2,G=N*4,V=4,I=V*4;function et(n,t,e){return n&~(1<<t)|Number(e)<<t}class st{constructor(t){a(this,"midi");a(this,"gamepad");a(this,"keyboard");a(this,"pointer");a(this,"u_input");a(this,"digital_signals",[]);a(this,"analog_signals",[]);this.midi=new T,this.gamepad=new q,this.keyboard=new J,this.pointer=new tt(t);const e=new U(g.VEC4U,N,new Uint32Array(G)),s=new U(g.VEC4F,V,new Float32Array(I));this.u_input=new O(1,[{name:"digital",value:e},{name:"analog",value:s}])}init(){this.midi.init(),this.gamepad.init(),this.keyboard.init(),this.pointer.init()}update_digital(t){const e=new Uint32Array(G);for(let s=0;s<this.digital_signals.length;s++){const i=this.digital_signals[s];i.update(t);const o=s&31,r=s>>5;e[r]=et(e[r],o,i.value)}this.u_input.get_uniform("digital").value=e}update_analog(t){const e=new Float32Array(I);for(let s=0;s<this.analog_signals.length;s++){const i=this.analog_signals[s];i.update(t),e[s]=i.value}this.u_input.get_uniform("analog").value=e}update(t,e){this.gamepad.update(),this.update_digital(e),this.update_analog(e),this.u_input.update(t)}create_resources(t){this.u_input.create(t)}configure_uniforms(t){t.digital&&this.digital_signals.push(...t.digital),t.analog&&this.analog_signals.push(...t.analog)}}class nt{constructor(t,e){a(this,"label");a(this,"entries");a(this,"layout");a(this,"bind_group");this.label=t,this.entries=e}create(t){this.layout=t.createBindGroupLayout({label:this.label,entries:this.entries.map(e=>e.layout_entry)}),this.bind_group=t.createBindGroup({label:this.label,layout:this.layout,entries:this.entries.map(e=>e.bind_group_entry)})}attach(t,e){if(!this.bind_group)throw new Error("Bind group not ready!");e.setBindGroup(t,this.bind_group)}}async function it(){var t;const n=await((t=navigator.gpu)==null?void 0:t.requestAdapter());if(!n)throw new Error("WebGPU not supported ðŸ˜¢");return await n.requestDevice()}function at(n){const t=document.getElementById(n);if(!t)throw new Error(`could not find canvas #${n}`);return t}function rt(n){const t=n.getContext("webgpu");if(!t)throw new Error("Could not get WebGPU context ðŸ˜¢");return t}class ot{constructor(t){a(this,"input");a(this,"machine");a(this,"u_frame");a(this,"bind_group");a(this,"canvas");this.canvas=at("webgpu-canvas"),this.input=new st(this.canvas),this.machine=t;const e=new Z(g.F32,new Float32Array([0]));this.u_frame=new O(0,[{name:"time",value:e}]),this.bind_group=new nt("per_frame",[this.u_frame,this.input.u_input])}async main(){this.input.init();const t=await it(),e=rt(this.canvas);await this.create_resources(t,e),this.configure_input();const s=performance.now(),i=()=>{const o=(performance.now()-s)/1e3;this.update(t,o);const r=t.createCommandEncoder();this.configure_passes(r,e),t.queue.submit([r.finish()]),requestAnimationFrame(i)};requestAnimationFrame(i)}async create_resources(t,e){this.u_frame.create(t),this.input.create_resources(t),this.bind_group.create(t),await this.machine.create_resources(t,this.canvas,e,this.bind_group)}configure_input(){this.machine.configure_input(this.input)}update(t,e){this.input.update(t,e),this.u_frame.get_uniform("time").value=new Float32Array([e]),this.u_frame.update(t),this.machine.update(e)}configure_passes(t,e){this.machine.configure_passes(t,e,this.bind_group)}}const ct={id:"webgpu-canvas",width:"500",height:"700"},ut=y({__name:"WebGPUSketch",props:{sketch_metadata:{}},setup(n){const t=n,e=P(()=>{const s=t.sketch_metadata.make_machine();return new ot(s)});return K(()=>{e.value.main()}),(s,i)=>(v(),w("canvas",ct))}}),ht=D(ut,[["__scopeId","data-v-21e10e8f"]]);function dt(n,t){const e=n.toDataURL(),s=document.createElement("a");s.href=e,s.download=t,document.body.appendChild(s),s.click(),s.remove()}const _t=y({__name:"ScreenshotButton",setup(n){function t(){const e=document.getElementById("webgpu-canvas");e&&dt(e,"screenshot.png")}return(e,s)=>(v(),w("button",{onClick:t},"Screenshot"))}}),F=n=>(j("data-v-d7bba1d0"),n=n(),H(),n),lt={key:0,class:"one-column vertical"},pt=F(()=>l("div",{class:"break"},null,-1)),mt=F(()=>l("div",{class:"break"},null,-1)),ft={class:"description"},gt=["innerHTML"],bt=y({__name:"SketchView",setup(n){const t=X(),e=P(()=>{const s=t.params.sketch_id,i=Array.isArray(s)?s[0]:s;return x(i)});return W(s=>{const i=s.params.sketch_id,o=Array.isArray(i)?i[0]:i;return x(o)?s:{path:"/404"}}),(s,i)=>e.value?(v(),w("div",lt,[l("h1",null,A(e.value.title)+" ("+A(e.value.years)+")",1),z(ht,{sketch_metadata:e.value},null,8,["sketch_metadata"]),pt,z(_t),mt,l("div",ft,[l("div",{innerHTML:e.value.description},null,8,gt)])])):Y("",!0)}}),vt=D(bt,[["__scopeId","data-v-d7bba1d0"]]);export{vt as default};
